var assert = require('assert'),
    PaymentRequest = require('../payment-request.js');

var chainPRHex = '120b783530392b7368613235361abd180afd0e3082077930820661a00302010202100b79d3cf1fed36e9e1f6db095badd6f3300d06092a864886f70d01010b05003075310b300906035504061302555331153013060355040a130c446967694365727420496e6331193017060355040b13107777772e64696769636572742e636f6d313430320603550403132b4469676943657274205348413220457874656e6465642056616c69646174696f6e20536572766572204341301e170d3134303532313030303030305a170d3136303732373132303030305a3081f9311d301b060355040f0c1450726976617465204f7267616e697a6174696f6e31133011060b2b0601040182373c0201031302555331193017060b2b0601040182373c020102130844656c61776172653110300e0603550405130735323836323038310c300a06035504091303333031311a301806035504091311313830302053204272616e6420426c7664310e300c060355041113053931323034310b3009060355040613025553311330110603550408130a43616c69666f726e69613111300f06035504071308476c656e64616c6531133011060355040a130a436861696e20496e632e3112301006035504031309636861696e2e636f6d30820122300d06092a864886f70d01010105000382010f003082010a0282010100b00163c78a5ce843685e8b01c08147c523043c0e55c9bcd625717036e353cd3a35afb88ed97a1222d6921af4ee335bc5cb5ae293b9fd31e740b00942b4f01713309ef42e056d67b93afb98cfe0a1a51c6b934dcdfd17a8ed617d8ebf9391773b6d683c162151228104bb7b6a0a766f0116d40bd10ce5acf89a387916abda110f69088bbfc30f3ee633123c62fef71b2f9053170b88dfb1a9d28b4610b2e3e9f5b4b8e8f216fc83891860c75439c4f06c233093b10c5d7725bf2e6e2fc6679d69726ea6afcbd2d90d406ef28837d200f37293ec5f99571810a9b8c987e7d77ac22de66a0245a672960771c79c23b6c900c4307507c918b91731f52dbb6b7df15b0203010001a382037e3082037a301f0603551d230418301680143dd350a5d6a0adeef34a600a65d321d4f8f8d60f301d0603551d0e04160414c224851cf06ee9c155561512bc601387cc8f38ee30320603551d11042b30298209636861696e2e636f6d820d6170692e636861696e2e636f6d820d6465762e636861696e2e636f6d300e0603551d0f0101ff0404030205a0301d0603551d250416301406082b0601050507030106082b0601050507030230750603551d1f046e306c3034a032a030862e687474703a2f2f63726c332e64696769636572742e636f6d2f736861322d65762d7365727665722d67312e63726c3034a032a030862e687474703a2f2f63726c342e64696769636572742e636f6d2f736861322d65762d7365727665722d67312e63726c30420603551d20043b3039303706096086480186fd6c0201302a302806082b06010505070201161c68747470733a2f2f7777772e64696769636572742e636f6d2f43505330818806082b06010505070101047c307a302406082b060105050730018618687474703a2f2f6f6373702e64696769636572742e636f6d305206082b060105050730028646687474703a2f2f636163657274732e64696769636572742e636f6d2f446967694365727453484132457874656e64656456616c69646174696f6e53657276657243412e637274300c0603551d130101ff040230003082017f060a2b06010401d6790204020482016f0482016b0169007500a4b90990b418581487bb13a2cc67700a3c359804f91bdfb8e377cd0ec80ddc100000014b3cc87c8d0000040300463044022057c9e31e828f6486f6c495e67e032e8dc4a9865e2e8820512a7371950785f31902206528fd998d1bf8e0eba960e5e63c97c2b2420ea3b2b414c5ef21db0b9c61146800770068f698f81f6482be3a8ceeb9281d4cfc71515d6793d444d10a67acbb4f4ffbc40000014b3cc87c550000040300483046022100d322b9925b0eee9e8acd46a5276f366d6d23d81d972376714cb9933f48fc4a2f02210094a142794a072608288e04cd2e9b0bf04cb4763596f2a6c5607bd41a806ead6d0077005614069a2fd7c2ecd3f5e1bd44b23ec74676b9bc99115cc0ef949855d689d0dd0000014b3cc87dfc0000040300483046022100bc3b8074c10dab05a5413223861625712b61f46b072b139e45e2cefb7d38649e0221009bd0b91113b9db344c88fb55729454caeeb801a17ce74ce3dc75130b7e84c6cd300d06092a864886f70d01010b050003820101004a5f52f839a18ee0f4d3540d62bf184e2a537b38218a0901ca49d8b9d1fd3f2be372fe8581b57acc6bab2432a7b4be9b69fc7c5f0aa63abafa199c35d6b0fccbd8001f2f2d6cfd9eff3dc1da94ff8b710feabfb5bdd1ee7ee304c365b2134ee72f13e886f30d7085fd699129017c9e3fac34692af36ef6b936037ff972533e82de2ae2f068acabbb19b57832e9ca3d4283b0885a6b7df26aa8baa7732883ab46ccd836d4f0f5c0fbb7661351c6ce983cf7b5d75548ac8e8c4789b3c55d8219fe18d60f20dcb5eb4b5b8d1b85f4373c345c13f5bea63e4b1a5859f41437140176e07c72903569ae4de407fa99832d3bedb7be410d2eada2f741787304e91104070aba09308204b63082039ea00302010202100c79a944b08c11952092615fe26b1d83300d06092a864886f70d01010b0500306c310b300906035504061302555331153013060355040a130c446967694365727420496e6331193017060355040b13107777772e64696769636572742e636f6d312b30290603550403132244696769436572742048696768204173737572616e636520455620526f6f74204341301e170d3133313032323132303030305a170d3238313032323132303030305a3075310b300906035504061302555331153013060355040a130c446967694365727420496e6331193017060355040b13107777772e64696769636572742e636f6d313430320603550403132b4469676943657274205348413220457874656e6465642056616c69646174696f6e2053657276657220434130820122300d06092a864886f70d01010105000382010f003082010a0282010100d753a40451f899a616484b6727aa9349d039ed0cb0b00087f1672886858c8e63dabcb14038e2d3f5eca50518b83d3ec5991732ec188cfaf10ca6642185cb071034b052882b1f689bd2b18f12b0b3d2e7881f1fef387754535f80793f2e1aaaa81e4b2b0dabb763b935b77d14bc594bdf514ad2a1e20ce29082876aaeead764d69855e8fdaf1a506c54bc11f2fd4af29dbb7f0ef4d5be8e16891255d8c07134eef6dc2decc48725868dd821e4b04d0c89dc392617ddf6d79485d80421709d6f6fff5cba19e145cb5657287e1c0d4157aab7b827bbb1e4fa2aef2123751aad2d9b86358c9c77b573add8942de4f30c9deec14e627e17c0719e2cdef1f9102819330203010001a38201493082014530120603551d130101ff040830060101ff020100300e0603551d0f0101ff040403020186301d0603551d250416301406082b0601050507030106082b06010505070302303406082b0601050507010104283026302406082b060105050730018618687474703a2f2f6f6373702e64696769636572742e636f6d304b0603551d1f044430423040a03ea03c863a687474703a2f2f63726c342e64696769636572742e636f6d2f4469676943657274486967684173737572616e63654556526f6f7443412e63726c303d0603551d200436303430320604551d2000302a302806082b06010505070201161c68747470733a2f2f7777772e64696769636572742e636f6d2f435053301d0603551d0e041604143dd350a5d6a0adeef34a600a65d321d4f8f8d60f301f0603551d23041830168014b13ec36903f8bf4701d498261a0802ef63642bc3300d06092a864886f70d01010b050003820101009db6d09086e18602edc5a0f0341c74c18d76cc860aa8f04a8a42d63fc8a94dad7c08ade6b650b8a21a4d8807b12921dce7dac63c21e0e3114970ac7a1d01a4ca113a57ab7d572a4074fdd31d851850df574775a17d55202e473750728c7f821bd2628f2d035adac3c8a1ce2c52a20063eb73ba71c84927239764859e380ead63683cba52815879a32c0cdfde6deb31f2baa07c6cf12cd4e1bd77843703ce32b5c89a811a4a924e3b469a85fe83a2f99e8ca3cc0d5eb33dcf04788f14147b329cc700a65cc4b5a1558d5a5668a42270aa3c8171d99da8453bf4e5f6a251ddc77b62e86f0c74ebb8daf8bf870d795091909b183b915927f1352813ab267ed5f77a2225121b08001217a91402df3de57a1089737b108f25856c47623985b48d8718fbd5d9aa052a002a8002846d1514cd0c1d9a6e18688c911019945ce3306ad3c8e42c78b68c6d31753bee8dbd6fa61a9b691caaf22aafb48e7c7872c50e33c25ce53c736012c4e88178adea3dac4a79ac3825ae198bba20afe0cd8ce57ad45717bc148da3017f36717c00298a43b132999d5480e89866509ec44c109e68ef629a13d0e772a8eb4468ed826232e31a3cee8356957d2a6592807c59dd25ad14e3a59afbce40a1f6c12d9886065db5df892333b77bc4f29e8af3afbf2216ff4e6dc888191ef91d6cfbcd2b21a25163e7cab47735677d99ccc1f966f6a0f4a7a8ef8d05ae51fda5bc251bde03d3dea99f8077da88f93e4c7ee11385ea49b41379701353ab74fec7face70c0a9';
var selfSignedHex = '120b783530392b7368613235361aa1050a9e053082029a30820182020900b6d22703e70222b0300d06092a864886f70d0101050500300f310d300b060355040313046865796f301e170d3135303531393233343133345a170d3136303531383233343133345a300f310d300b060355040313046865796f30820122300d06092a864886f70d01010105000382010f003082010a0282010100ee36d62d30982324b7c4860083a9d0fce7b2bc6ba895416cc03441309cdb232377cd070c7c9c4864b1e84465efacce752e33d5b07f63cd5ee0c9f88069a8d7d30b4ba1763efbd397d5e6cfb0eff8ffb6dcf3fa9ba51ac0dfd117e20d17294c821ba9ca6b3cc272e92cf7d5383b0e131730b86771bca3a0c0cc27356f4dbac9f8a397ece58d0861bc75dd2628b8ddad6487481f38cd0e4c7bd20b8d4a74889b37f6e7cee1ee327072bf58ac38d0ab82ea90d0dc273454aa0804e74f8e483465eae25eb16b078b28dc00c459ab621c3b92ff08ab1ff11123fce71e33e7988dd254b61298823c5557d16d36aa97594eeae55eda309cfe534445d21b545255828e970203010001300d06092a864886f70d01010505000382010100610df36c084c43820a818b82e481b2593a8a3d6bb53582853e7ef34682f2911636405fff6d31eebab0502edacebdd319581044f8d3e88a17421d0a237d1c8ac159ebed45e341ac7f29b53ccb2d870d897ce7d36076a2deec9afe95a8b30e06f486c74c24433418b8eedef838315be4857fda276defedd487d03ac50056ec45e10f7caa2393693385b13b0fd228a3301fe4acd63cb3926f19ebf72c852258447325ce8c14fd783ddb05bf3afd2771716812c781151ed867d28f7b5e3f22f812cd9b1359844a3abc4ae928b4adf33c3dbd8ee246cf8bbb4dc59eacf18efdeac2694df880d92702ebec83d622681be23a58b92266ffe2adf0c55312a874e2cfcfff2225121b08001217a914fb8bd60a8e99903d8f429ee48047009ead1655318718b594efaa052a002a80022d5b74e0b5a50d7470bdfda2d1cc36278a60b6efb0e46dbf86412d42106757e584bae48f48b4082e4d86a91e54ae6edd18f56ec9c830043b20dad5396318e40bc7454345a3734303f4d918ab1ae2f06a6e2deb53cbf3f13edf832f0af2205c304070e1419124edff77a0554475db32e20cada5f08e545fb4af0d834f906d9293fae44e0131bb200bb27e6f03ce9c6f9da216dc131663ca9ba17bc8cb57198ae87380ff129d149fdc6e8f4b60d40c38042fe8e65d2a0d91cc121ddb4704229b969adad12e5b21014c5be1a3e52d6506e7c9e48d838b3cb916ff21623c9e0aa94b8444aa95bbe34ca8cc4500154aaf9a67f36cb1311fbff40972b727948fef9178';
var badSigHex = '120b783530392b7368613235361aa1050a9e053082029a30820182020900b6d22703e70222b0300d06092a864886f70d0101050500300f310d300b060355040313046865796f301e170d3135303531393233343133345a170d3136303531383233343133345a300f310d300b060355040313046865796f30820122300d06092a864886f70d01010105000382010f003082010a0282010100ee36d62d30982324b7c4860083a9d0fce7b2bc6ba895416cc03441309cdb232377cd070c7c9c4864b1e84465efacce752e33d5b07f63cd5ee0c9f88069a8d7d30b4ba1763efbd397d5e6cfb0eff8ffb6dcf3fa9ba51ac0dfd117e20d17294c821ba9ca6b3cc272e92cf7d5383b0e131730b86771bca3a0c0cc27356f4dbac9f8a397ece58d0861bc75dd2628b8ddad6487481f38cd0e4c7bd20b8d4a74889b37f6e7cee1ee327072bf58ac38d0ab82ea90d0dc273454aa0804e74f8e483465eae25eb16b078b28dc00c459ab621c3b92ff08ab1ff11123fce71e33e7988dd254b61298823c5557d16d36aa97594eeae55eda309cfe534445d21b545255828e970203010001300d06092a864886f70d01010505000382010100610df36c084c43820a818b82e481b2593a8a3d6bb53582853e7ef34682f2911636405fff6d31eebab0502edacebdd319581044f8d3e88a17421d0a237d1c8ac159ebed45e341ac7f29b53ccb2d870d897ce7d36076a2deec9afe95a8b30e06f486c74c24433418b8eedef838315be4857fda276defedd487d03ac50056ec45e10f7caa2393693385b13b0fd228a3301fe4acd63cb3926f19ebf72c852258447325ce8c14fd783ddb05bf3afd2771716812c781151ed867d28f7b5e3f22f812cd9b1359844a3abc4ae928b4adf33c3dbd8ee246cf8bbb4dc59eacf18efdeac2694df880d92702ebec83d622681be23a58b92266ffe2adf0c55312a874e2cfcfff2225121b08001217a914fa5eadd77c30bc4e0e589b9bcff1c611f8fe4a6a8718c59eefaa052a002a8002b8b0b2507e5a431a42166d43e596fe429bbec490f50df473a4b957c4e52d578f426a5a860e6fdcd30a0e29152dd6eaf4b9424a5db1cedbd2f92675c8bb44e29b81d09ed39e88be6d217de4e648c71832ff2c6e2b3d9905dea7139952f8469252f81c34858f832a2c8d5752acd2dc707e8354063a1e949f71d189da5bc95832b56822c3c12c1a71aa8f8ac1ab35ad14b42804b043ef3fc54d300ab1f9b6abebdbac6bbd4e8f2381507fbda2d92d3ab12cdc776ff310f702b59951cdb388d7f9763901d250f490acf12a82709a08a731d44096657c1f421cd1de5e9f2c663a9236fdf08245838ab117248de57f146face837c0079dd065b6dec35cac36115d885a';
var noSigHex = '2226121c0888271217a9146dcc9ff4fc7db03d3a71c195866410b5150011fb8718cda7efaa052a00';

describe('PaymentRequest', function () {

    describe('#outputs()', function () {
        it("should return an array of outputs in transact format", function () {
            var pr = new PaymentRequest(new Buffer(chainPRHex, 'hex'));
            var outputs = pr.outputs();
            assert.equal(outputs.length, 1);
            assert.equal(outputs[0].amount, 0);
            assert.equal(outputs[0].address, "31xCi3BU51v96dbmFjstxfcqvtthPnrbPS");
            assert.equal(pr.amount, 0);

            var pr2 = new PaymentRequest(new Buffer(noSigHex, 'hex'));
            outputs = pr2.outputs();
            assert.equal(outputs.length, 1);
            assert.equal(outputs[0].amount, 5000);
            assert.equal(outputs[0].address, "3Bhai32qFXmU1NghdrBAByaCueGjBRxjrm");
            assert.equal(pr2.amount, 5000);
        });
    });

    describe('#certInfo()', function () {
        it("should return all the certificate subject information", function () {
            var pr = new PaymentRequest(new Buffer(chainPRHex, 'hex'));
            var info = pr.certInfo();
            assert(info);
            assert.equal(info.commonName, "chain.com");
            assert.equal(info.businessCategory, 'Private Organization');
            assert.equal(info.incorporationCountry, 'US');
            assert.equal(info.incorporationState, 'Delaware');
            assert.equal(info.organization, 'Chain Inc.');
        });
    });

    describe('#hasValidSignature()', function () {
        it("should return true for valid x509 signature", function () {
            var pr = new PaymentRequest(new Buffer(chainPRHex, 'hex'));
            assert(pr.hasValidSignature());

            var pr2 = new PaymentRequest(new Buffer(selfSignedHex, 'hex'));
            assert(pr2.hasValidSignature());
        });

        it("should return false for invalid x509 signature", function () {
            var pr = new PaymentRequest(new Buffer(badSigHex, 'hex'));
            assert(!pr.hasValidSignature());
        });

        it("should return false for no cert", function () {
            var pr = new PaymentRequest(new Buffer(noSigHex, 'hex'));
            assert(!pr.hasValidSignature());
        });
    });

    describe('#hasValidCertChain()', function () {
        it("should return true for a cert chain minus a root trusted cert", function () {
            var pr = new PaymentRequest(new Buffer(chainPRHex, 'hex'));
            assert(pr.hasValidCertChain());
        });

        it("should return false for a self-signed certificate", function () {
            var pr = new PaymentRequest(new Buffer(selfSignedHex, 'hex'));
            assert(!pr.hasValidCertChain());
        });

        it("should return false for no cert", function () {
            var pr = new PaymentRequest(new Buffer(noSigHex, 'hex'));
            assert(!pr.hasValidCertChain());
        });
    });
});
